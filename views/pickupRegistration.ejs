<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" href="/GLOSLogo.png">
    <title>Pickup Soccer Registration</title>
</head>
<body style="text-align: center;">
    <script>
        function millisecondsToTimeString(milliseconds) {
            if (milliseconds < 0 || milliseconds >= 86400000) {
                throw new Error("Milliseconds must be between 0 and 86399999.");
            }

            const totalMinutes = Math.floor(milliseconds / 60000); // Convert to total minutes
            const hours24 = Math.floor(totalMinutes / 60); // Extract hours (24-hour format)
            const minutes = totalMinutes % 60; // Extract remaining minutes

            // Convert 24-hour format to 12-hour format and determine AM/PM
            const period = hours24 >= 12 ? "pm" : "am";
            const hours12 = hours24 % 12 || 12; // Convert to 12-hour format (0 becomes 12)

            // Format the result as a time string
            return `${hours12}:${minutes.toString().padStart(2, "0")}${period}`;
        }
    </script>
    <header>
        <h1>Pickup Futsal Signup</h1>
    </header>
    <br>
    <main>
        <form action="" method="POST" onsubmit="return handleSubmit(this,event)">
            <label for="date"><input type="text" name="date" value="<%= data.pickupEvents[0].date %>" hidden><%= functions.formatDate(data.pickupEvents[0].date) %></label>
            <br><br>

            <input type="email" id="email" name="email" placeholder="Email" required>
            <br>
            <input type="text" name="firstName" placeholder="First Name" required>
            <input type="text" name="lastName" placeholder="Last Name" required>
            <br>
            
            <br>
            

            <% console.log(data) %>
            <% for (var i=0; i<data.pickupEvents.length;i++) {%>
            <label>
                <input type="checkbox" name="hour" value="<%= data.pickupEvents[i].time %>"> <%= functions.millisecondsToTimeString(data.pickupEvents[i].time) %>
            </label>
            <br>
            <% } %>
            <br>
            <button type="submit" class="primaryBorder" style="border-width: thin;">Sign Up</button>
        </form>
    </main>
    <br>
    <footer>
        <p>&copy; 2024 Pickup Soccer</p>
    </footer>
    <script>
        
        function validateCheckboxes(form) {
            const checkboxes = form.querySelectorAll('input[name="hour"]');
            for (const checkbox of checkboxes) {
                if (checkbox.checked) {
                    return true; // At least one checkbox is checked
                }
            }
            alert("Please select at least one option.");
            return false; // No checkbox is checked
        }
        function handleSubmit(form,event) {
            if (!validateCheckboxes(form)) {
                return false; 
            }
            paymentSubmit(form,event)
        }
        async function fillExistingUserInfo(emailElement){
            var form = emailElement.form;
            var formData = new FormData(form)
            // console.log(formData)
            const response = await fetch('/games/checkEmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(formData).toString()
            })
            if (response.ok) {
                const responseData = await response.json();
                console.log(responseData)
                if(responseData.user){
                    form.querySelector('[name="firstName"]').value = responseData.user.firstName
                    form.querySelector('[name="lastName"]').value = responseData.user.lastName
                    form.querySelector('[name="preferredName"]').value = responseData.user.preferredName
                    form.querySelector('[name="waiver"]').checked = true
                }else{
                    form.querySelector('[name="firstName"]').value = ''
                    form.querySelector('[name="lastName"]').value = ''
                    form.querySelector('[name="preferredName"]').value = ''
                    form.querySelector('[name="waiver"]').checked = false
                }
                // location.reload()
            } else {
                console.error('Form submission failed');
                // Handle error response
            }
        }
        document.getElementById('newPlayerForm').querySelector('[name="email"]').addEventListener('blur',async function() {
            var email = this.value;
            var formData = new FormData(document.getElementById('newPlayerForm'))
            console.log(formData)
            const response = await fetch('/games/checkEmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(formData).toString()
            })
            if (response.ok) {
                const responseData = await response.json();
                console.log(responseData)
                if(responseData.user){
                    this.form.querySelector('[name="firstName"]').value = responseData.user.firstName
                    this.form.querySelector('[name="lastName"]').value = responseData.user.lastName
                    this.form.querySelector('[name="preferredName"]').value = responseData.user.preferredName
                    this.form.querySelector('[name="waiver"]').checked = true
                }else{
                    this.form.querySelector('[name="firstName"]').value = ''
                    this.form.querySelector('[name="lastName"]').value = ''
                    this.form.querySelector('[name="preferredName"]').value = ''
                    this.form.querySelector('[name="waiver"]').checked = false
                }
                // location.reload()
            } else {
                console.error('Form submission failed');
                // Handle error response
            }
        });
    </script>
    <script src="/main.js"></script>
</body>
</html>
